# Шина событий

Шина событий реализует кооперативную многозадачность между выполняемыми внутри неё действиями. Каждое действие выполняется внутри отдельной нити (Fiber) в изолированном DI-контейнере. Управлять выполнением можно с помощью обработчиков состояний, триггеров и подписок на генерируемые действиями события.


### Типы состояний

**Состояния основного контекста:**

* StateMainBegin - наступает единожды перед стартом шины
* StateMainCyclic - наступает хотя бы раз и повторяется пока очередь задач не пуста в режиме `Mode::Queue`, или циклично если `Mode::Loop`
* StateMainBefore - наступает перед сборкой и запуском действия
* StateMainSuspend - наступает если действие вызывает `Fiber::suspend()`
* StateMainResume - наступает перед возвратом управления в действие. Если в `Fiber::suspend()` была передана callback-функция - она будет запущена
* StateMainAfter - наступает после выполнения действия
* StateMainEnd - наступает когда очередь задач пуста и все действия завершены (достижимо только в режиме `Mode::Queue`)

**Состояния в контексте действия (внутри Fiber):**

* StateActionBefore - наступает перед выполнением действия
* StateActionAfter - наступает после выполнения действия
* StateActionThrowing - наступает в случае если действие выбросило исключение

Каждое состояние может быть обработано с помощью обработчиков состояний. Для каждого типа состояния, предусмотрен определённый набор функций, доступных для взаимодействия с шиной из обработчика состояния.


### Обзор свойств для действий

`string $id` - Уникальный идентификатор действия. Например: `'MyService.DoWork'`.

`string|Closure $handler` - Анонимная функция или вызываемый класс обработчик действия.

`array $required` - Массив идентификаторов действий. Целевое действие может затребовать выполнения других действий, которые будут являться условием для выполнения целевого действия. Результат выполнения затребованных действий может быть передан в целевое действие. В случае если хотя бы одно из затребованных действий вернуло результат со статусом `ResultStatus::Fail`, то целевое действие выполнено не будет.

`?string $triggeredOn` - Действие будет запущено после того как триггер с указанным ID будет передан в шину.

`array $bind` - Массив маппинга интерфейсов для DI-контейнера. Например: `[MyInterface::class => MyClass::class]`. См. [DI](https://github.com/duyler/dependency-injection).

`array $providers` Массив сервис-провайдеров для DI-контейнера. См. [DI](https://github.com/duyler/dependency-injection).

`?string $argument` - Тип аргумента действия.

`string|Closure|null $argumentFactory` - Анонимная функция или выполняемый класс-фабрика для аргумента действия.

`?string $contract` - Тип возвращаемый действием.

`string|Closure|null $rollback` - Анонимная функция или выполняемый класс, вызываемый для отката действия, в случае если было выброшено исключение в любом месте программы.

`bool $externalAccess` - Разрешение доступа к результату выполнения действия из `BusInterface` или обработчиков состояний.

`bool $repeatable` - Разрешение повторно выполнять действие.

`bool $lock` - Если действие использует параллельное выполнение внутри `Fiber::suspend()` (напр. Parallel php extension), это гарантирует последовательность выполнения повторяемых действий.

`bool $private` - Если установлено значение true, это действие НЕ МЕЖЕТ быть требовано в других действиях.

`array $sealed` - Массив идентификаторов действий, которым разрешено запрашивать это действие и получать его результат.

`bool $silent` - Если установлено значение true, действие НЕ БУДЕТ генерировать внутреннее событие выполнения этого действия. Подписка на такое действие невозможна и сгенерирует исключение.

`array $alternates` - Массив идентификаторов действий, результат которых может заменить результат выполнения целевого действия. Результат текущего целевого действия будет заменён, если оно вернёт результат со статусом ResultStatus::Fail.

`int $retries` - Количество повторов, если действие возвращает результат с ResultStatus:Fail.

`int $labels` - Любые произвольные данные. Может быть полезно при реализации обработчиков состояний.
